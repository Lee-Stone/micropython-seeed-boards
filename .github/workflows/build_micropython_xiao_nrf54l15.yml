name: Build MicroPython Firmware for Seeed Xiao nRF54L15

on:
  workflow_call:
    inputs:
      trigger:
        required: true
        type: string
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Set up Python (required for Zephyr and west)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Install Zephyr dependencies
      - name: Install Zephyr dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build gperf ccache \
            dfu-util device-tree-compiler python3-dev python3-pip python3-setuptools \
            python3-tk python3-wheel xz-utils file libpython3-dev libffi-dev gh
          pip3 install west

      # Initialize and set up Zephyr
      - name: Set up Zephyr
        run: |
          west init -m https://github.com/nrfconnect/sdk-nrf --mr v3.0.2 ncs
          cd ncs
          west update
          west zephyr-export
          pip3 install -r zephyr/scripts/requirements.txt

      # Install Zephyr SDK
      - name: Install Zephyr SDK
        run: |
          wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-x86_64.tar.xz
          mkdir -p ~/zephyr-sdk
          tar -xvf zephyr-sdk-0.17.0_linux-x86_64.tar.xz -C ~/zephyr-sdk
          cd ~/zephyr-sdk/zephyr-sdk-0.17.0
          ./setup.sh -t all -h

      # Build MicroPython for Xiao nRF54L15
      - name: Build for Xiao nRF54L15
        run: |
          source ncs/zephyr/zephyr-env.sh
          pushd lib/micropython/ports/zephyr
          git fetch origin
          git reset --hard origin/master
          gh pr checkout 18030
          popd

          export PROJECT_DIR=$(pwd)
          sed -i '10s/#include <version.h>/#include <zephyr\/version.h>/' ncs/nrf/lib/boot_banner/banner.c
          west build --build-dir ./build_nrf54l15 ./lib/micropython/ports/zephyr \
            --pristine \
            --board xiao_nrf54l15/nrf54l15/cpuapp \
            --sysbuild \
            -- \
            -DBOARD_ROOT=$PROJECT_DIR/ \
            -DEXTRA_DTC_OVERLAY_FILE=$PROJECT_DIR/boards/xiao_nrf54l15_nrf54l15_cpuapp.overlay \
            -DPM_STATIC_YML_FILE=$PROJECT_DIR/boards/pm_static_xiao_nrf54l15_nrf54l15_cpuapp.yml \
            -DEXTRA_CONF_FILE=$PROJECT_DIR/boards/xiao_nrf54l15_nrf54l15_cpuapp.conf 
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZEPHYR_SDK_INSTALL_DIR: ~/zephyr-sdk/zephyr-sdk-0.17.0

      # Upload Xiao nRF54L15 firmware artifacts
      - name: Upload Xiao nRF54L15 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xiao-nrf54l15-firmware
          path: |
            build_nrf54l15/zephyr/zephyr/zephyr.elf
            build_nrf54l15/zephyr/zephyr/zephyr.hex

      # Upload Xiao nRF54L15 artifacts to Release (only on release event)
      - name: Upload Xiao nRF54L15 artifacts to Release
        if: github.event_name == 'release'
        run: |
          mv build_nrf54l15/zephyr/zephyr/zephyr.hex build_nrf54l15/zephyr/zephyr/xiao_nrf54l15.hex
          gh release upload ${{ github.event.release.tag_name }} \
            build_nrf54l15/zephyr/zephyr/xiao_nrf54l15.hex \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}