name: Build MicroPython Firmware for Seeed Xiao nRF52840

on:
  workflow_call:
    inputs:
      trigger:
        required: true
        type: string
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Set up Python (required for Zephyr and west)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Install Zephyr dependencies
      - name: Install Zephyr dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git cmake ninja-build gperf ccache \
            dfu-util device-tree-compiler python3-dev python3-pip python3-setuptools \
            python3-tk python3-wheel xz-utils file libpython3-dev libffi-dev gh
          pip3 install west

      # Initialize and set up Zephyr
      - name: Set up Zephyr
        run: |
          west init -m https://github.com/nrfconnect/sdk-nrf --mr v3.0.2 ncs
          cd ncs
          west update
          west zephyr-export
          pip3 install -r zephyr/scripts/requirements.txt

      # Install Zephyr SDK
      - name: Install Zephyr SDK
        run: |
          wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-x86_64.tar.xz
          mkdir -p ~/zephyr-sdk
          tar -xvf zephyr-sdk-0.17.0_linux-x86_64.tar.xz -C ~/zephyr-sdk
          cd ~/zephyr-sdk/zephyr-sdk-0.17.0
          ./setup.sh -t all -h
          
      # Build MicroPython for Xiao nRF52840
      - name: Build for Xiao nRF52840
        run: |
          source ncs/zephyr/zephyr-env.sh
          pushd lib/micropython/ports/zephyr
          git fetch origin
          git reset --hard origin/master
          gh pr checkout 18030
          popd
          
          sed -i '10s/#include <version.h>/#include <zephyr\/version.h>/' ncs/nrf/lib/boot_banner/banner.c
          west build --build-dir ./build_nrf52840 ./lib/micropython/ports/zephyr --pristine --board xiao_ble
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ZEPHYR_SDK_INSTALL_DIR: ~/zephyr-sdk/zephyr-sdk-0.17.0

      # Upload Xiao nRF52840 firmware artifacts
      - name: Upload Xiao nRF52840 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xiao-nrf52840-firmware
          path: |
            build_nrf52840/zephyr/zephyr/zephyr.elf
            build_nrf52840/zephyr/zephyr/zephyr.uf2

      # Upload Xiao nRF52840 artifacts to Release (only on release event)
      - name: Upload Xiao nRF52840 artifacts to Release
        if: github.event_name == 'release'
        run: |
          mv build_nrf52840/zephyr/zephyr.uf2 build_nrf52840/zephyr/xiao_nrf52840.uf2
          gh release upload ${{ github.event.release.tag_name }} \
            build_nrf52840/zephyr/xiao_nrf52840.uf2 \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}